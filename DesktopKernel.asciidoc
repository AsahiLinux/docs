This pages explain how to build a desktop kernel with the latest features. It also lists all kernel options that are necessary to get all ASAHI features and which one better to disable.

# Current Desktop Kernel
```
# Install Build Dependencies
sudo apt install -y gcc-aarch64-linux-gnu device-tree-compiler


if [ "`uname -m`" != 'aarch64' ]; then
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
fi
test -d linux || git clone --depth 1 https://github.com/AsahiLinux/linux
cd linux
curl -s https://tg.st/u/0001-4k-iommu-patch.patch | git am -
curl -s https://tg.st/u/DXyl.patch | git am -
curl -s https://tg.st/u/0001-apple-mca-correct-prinkts.patch | git am -
curl -s https://tg.st/u/config-2022-02-19 > .config
make olddefconfig
make -j $(( 2* `nproc`)) V=0 Image.gz modules dtbs
```

If you want to build debian packages

```
make -j $(( 2* `nproc`)) V=0 bindeb-pkg
```

# Kerneloptions

The following kernel options are necessary to get all features. FIXME: I think there are some for wifi missing.
```
CONFIG_APPLE_ADMAC=y
CONFIG_APPLE_AIC=y
CONFIG_APPLE_DART=y
CONFIG_APPLE_MAILBOX=y
CONFIG_APPLE_PMGR_PWRSTATE=y
CONFIG_APPLE_RTKIT=y
CONFIG_APPLE_SART=y
CONFIG_APPLE_WATCHDOG=y
CONFIG_ARCH_APPLE=y
CONFIG_BRCMFMAC=m
CONFIG_BRCMFMAC_PCIE=y
CONFIG_COMMON_CLK_APPLE_NCO=y
CONFIG_DRM_SIMPLEDRM=y
CONFIG_FW_LOADER_USER_HELPER=n
CONFIG_FW_LOADER_USER_HELPER_FALLBACK=n
CONFIG_HID_APPLE=y
CONFIG_HID_MAGICMOUSE=y
CONFIG_I2C_APPLE=y
CONFIG_NVME_APPLE=y
CONFIG_PCIE_APPLE=y
CONFIG_PCIE_APPLE_MSI_DOORBELL_ADDR=0xfffff000
CONFIG_PINCTRL_APPLE_GPIO=y
CONFIG_SND_SIMPLE_CARD=y
CONFIG_SND_SOC_APPLE_MCA=y
CONFIG_SND_SOC_CS42L42=y
CONFIG_SND_SOC_TAS2770=m
CONFIG_SPI_APPLE=y
CONFIG_SPI_HID_APPLE_CORE=y
CONFIG_SPI_HID_APPLE_OF=y
CONFIG_USB_DWC3=y
CONFIG_USB_DWC3_PCI=y
CONFIG_NLMON=m
CONFIG_CFG80211_WEXT=y
CONFIG_MMC_SDHCI_PCI=y
CONFIG_ARM_APPLE_SOC_CPUFREQ=y
CONFIG_RTC_DRV_MACSMC=y
CONFIG_NVMEM_SPMI_MFD=y
CONFIG_MFD_APPLE_SPMI_PMU=y
CONFIG_SPMI_APPLE=y
CONFIG_POWER_RESET_MACSMC=y
CONFIG_SND_SOC_APPLE_SILICON=y
CONFIG_GPIO_MACSMC=y
CONFIG_CHARGER_MACSMC=y
CONFIG_APPLE_PLATFORMS=y
CONFIG_APPLE_SMC=y
CONFIG_APPLE_SMC_RTKIT=y
CONFIG_DRM=y
```

The following kernel options should be disabled because otherwise loading the right firmware takes forever due to a timeout:

```
CONFIG_FW_LOADER_USER_HELPER_FALLBACK
CONFIG_FW_LOADER_USER_HELPER
```